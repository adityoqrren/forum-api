name: Continuous Deployment

on:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: SSH and deploy app
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            # debug
            whoami
            echo "SHELL=$SHELL"
            echo "Before PATH: $PATH"
            which node || echo "node not found before sourcing nvm"
            which npm  || echo "npm not found before sourcing nvm"

            # source nvm if exists
            export NVM_DIR="$HOME/.nvm"
            if [ -s "$NVM_DIR/nvm.sh" ]; then
              . "$NVM_DIR/nvm.sh"
              nvm use default || nvm use node || true
            fi

            echo "After source: PATH=$PATH"
            which node || echo "node still not found"
            node -v || true
            which npm || echo "npm still not found"
            npm -v || true

            cd ~/forum-api
            git pull origin master
            npm install
            npm run migrate up
            pm2 restart forum-api
